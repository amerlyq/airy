#!/bin/bash
set -o errexit
set -o pipefail
# [[ $- =~ i ]] && return || exit
cd $(dirname $(readlink -m ${0})) || exit

case "$1" in
dark|light|lucid|opaque) THEME="${1}" ;;
-u|--update) ARGS="$1" ;;
--clean) ARGS="$1" ;;
?*) echo "Error: no such option '$1'"; exit 1 ;;
esac

[[ "${THEME:=$(< ~/.cache/airy/theme)}" =~ ^[a-z]+$ ]] || THEME=dark
echo "$THEME" > ~/.cache/airy/theme


link(){ [[ ! -e $2 || -L $2 ]] && ln -sfvT "$1" $2; }
# ldir(){ mkdir -p $2 && lndir "$1" $2; }
pretty() { sed "s|/home/$(whoami)|\~|g;  s|\~/\S\+/cfg/||g;  />>>/!s|^|  |g
    /^>>> \.\//s||\n$(tput setaf 2)\[|g;  / <<<$/s||\]$(tput sgr0)|g"; }
header(){ printf "\n$(tput setaf ${2:-1})>>> %s <<<$(tput sgr0)\n" "$1"; }


header "Airy public"
link "$PWD/bin" ~/.bin

## Populate sensible configs
if [[ -f ../erian/setup ]]; then
    header "Erian private data"
    ../erian/setup "$ARGS" | pretty
fi


## Setup all configs (private data must be initialized already)
header "Airy cfgs"
# WARNING: what to do if not exists -- like on pure system setup?
source ~/.shell/profile || PKG_LIST=(shell 'shell/*')
for nm in "${PKG_LIST[@]}"; do
    find ./cfg -type f -wholename "*/$nm/setup" | while read fl
    do echo ">>> $fl <<<"; $fl $ARGS; done
done | pretty

## Subdirectories:
# for dir in "$PWD"/*; do if [[ -d "$dir" && -f "$dir/setup" ]]
# then echo ">>> Cfg: $dir <<<"; "$dir/setup" "$ARGS"; fi; done
## Packages
# [[ "${PKG_LIST[@]} " =~ "${PWD##*/} " ]] || exit
## Robust find with exec
# find . -mindepth 2 -type f -wholename "*/setup" -not -exec \
#     bash -c "echo '>>> {} <<<' && '{}' $ARGS || exit" \; -quit

header "DONE"

bash -ic "i3-msg restart && sleep 1"

#!/bin/bash -e
cd $(dirname $(readlink -m ${0})) && source ./cfg/shell/func.d/cfgsetup
# ======================================================================
echo "$THEME" > "${CURR_CACHE?No}/theme"

header(){ printf "\n$(tput setaf ${2:-1})>>> %s <<<$(tput sgr0)\n" "$1"; }
pretty() { sed "
    s|/home/$(whoami)|\~|g;  s|\~/\S\+/cfg/||g;  />>>/!s|^|  |g
        /^>>> \.\//s//\n$(tput setaf 2)\[/g
            / <<<$/s//\]$(tput sgr0)/g
    /\(C\|W\):\s.*/s//$(tput setaf 13)&$(tput sgr0)/
       /\(N\):\s.*/s//$(tput setaf 6)&$(tput sgr0)/
       /.*\s->\s.*/s//$(tput setaf 4)&$(tput sgr0)/
";}

header "Airy public" && {
    link "$PWD/bin" ~/.bin
    link "$PWD/cfg/shell" ~/.shell
} | pretty

# ======================================================================
## Populate sensible configs
if [[ -f ../erian/setup ]]; then
    header "Erian private data"
    ../erian/setup "$ARGS" | pretty
fi

# ======================================================================
## Setup all configs (private data must be initialized already)
header "Airy cfgs"
source ~/.shell/profile

case "${CURR_PROF:=headless}" in
laptop|home|work) PKG_LIST=(
    shell 'shell/*' core 'dev/*' 'term/*'
    Xrc 'Xrc/*' 'net/*' 'browser/*' media 'media/*'
) ;; *) PKG_LIST=(shell zsh git ranger tmux vim elinks)
;; esac

for nm in "${PKG_LIST[@]}"; do
    find ./cfg -type f -wholename "*/$nm/setup" | while read fl
    do echo ">>> $fl <<<"
        if cfgOpt i && [[ -f "${fl%/*}/install" ]]
        then "${fl%/*}/install"; echo; fi
        $fl $ARGS
    done
done | pretty

# ======================================================================

header "DONE"
cfgOpt u && i3-msg restart </dev/tty >/dev/null 2>&1

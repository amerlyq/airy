#!/bin/bash
cd $(dirname $(readlink -m ${0})) || exit
set -o errexit
set -o pipefail

# WARNING:
#   Now if file exsist, 'setup' simply exits and you will not know that
#   NEED: message on error -- if exist. Maybe some flags for 'ln' be enough?
#   SEE maybe aliases also can be placed/extracted in their own directories?
#        Then merged in one file?

case "$1" in
-u|--update) ARGS="$1" ;;
--clean) ARGS="$1" ;;
*) ARGS="" ;;
esac


link(){ [[ ! -e $2 || -L $2 ]] && ln -sfvT "$1" $2; }
pretty() { sed "
    s|/home/$(whoami)|\~|g
    s|\~/\S\+/cfg/||g
    />>>/!s|^|  |g
    /^>>> \.\//s||\n$(tput setaf 2)\[|g; / <<<$/s||\]$(tput sgr0)|g
"; }
header(){ printf "\n$(tput setaf ${2:-1})>>> %s <<<$(tput sgr0)\n" "$1"; }


header "Airy public"
link "$PWD/bin" ~/.bin


## Populate sensible configs
if [[ -f ../erian/setup ]]; then
    header "Erian private data"
    ../erian/setup "$ARGS" | pretty
fi

## Setup all configs (private data must be initialized already)
header "Airy cfgs"
cfgs=(shell/* browser/* media/* git init i3 mutt ranger sets urxvt vim Xrc)

for nm in "${cfgs[@]}"; do
    find ./cfg -type f -wholename "*/$nm/setup" | while read fl
    do echo ">>> $fl <<<"; $fl $ARGS; done
done | pretty

## Subdirectories:
# for dir in "$PWD"/*; do if [[ -d "$dir" && -f "$dir/setup" ]]
# then echo ">>> Cfg: $dir <<<"; "$dir/setup" "$ARGS"; fi; done
## Packages
# [[ "${PKG_LIST[@]} " =~ "${PWD##*/} " ]] || exit
## Robust find with exec
# find . -mindepth 2 -type f -wholename "*/setup" -not -exec \
#     bash -c "echo '>>> {} <<<' && '{}' $ARGS || exit" \; -quit

header "DONE"

#!/bin/zsh

ARG="$1"; shift
CMD="$@"

source ~/.shell/zsh/zshrc

gita_st() { # $1 -- rep path
    ST="$PR_SET_CHARSET$AM_GIT`git_prompt_info`$PR_NO_COLOUR `git_prompt_status`$PR_NO_COLOUR"
    st=$(echo "$ST" | sed 's/[%{}]//g')
    dt=$(git log -1 --pretty=format:'%ci' | awk '{ print $2,$1 }')
    printf "%-20s\t %-16s %-18s\n" "$st" "$1" "$dt"
    # echo -en " $1 `echo $ST | sed 's/[%{}]//g'`\n"
}

gita_pl() {
    printf "\n\n$(tput setaf 3)--[ $1 ]--$(tput sgr0)\n";
    # FIXME: Check if has remote updates
    # if [[ $(git rev-parse HEAD) == $(git ls-remote $(git rev-parse --abbrev-ref @{u})) ]]; then
        # Check if clean directory
        if git diff-files --quiet --ignore-submodules --
        then git pull --rebase --verbose
        else git stash && git pull --rebase --verbose && git stash pop
        fi
    # fi
}

# Так же вести себя и с пулом -- прошёл успешно если чистый или нужен коммит, стэш, merge итп -- парсить и заменять на значки

for rp in "$PWD"/*; do
    if [ -d "$rp/.git" ]; then
        cd "$rp" && gita_$ARG ${rp##*/}
        eval ${CMD:+git $CMD}
    fi
done


# for nm in *; do (cd $nm && pwd && gt && echo); done
# for nm in *; do (cd $nm && pwd && glu && echo); done

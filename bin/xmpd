#!/usr/bin/env bash
source ~/.shell/profile || exit

loadsongs() { sed 's/\s*#.*$//; /^\s*$/d' | while read song; do
    { mpc playlist -f "[%file%]" | grep -q "$song"; } || mpc load "$song"
done; }

case "$1" in
anime) loadsongs <<EOT
http://animeradio.su/playlists/gar.pls
http://animeradio.ru/play.m3u
http://listen.radionomy.com/radio-anime.m3u   # Banned at work
http://158.69.9.92:443/listen.pls
http://apple.neostreams.info:10007/listen.pls
EOT
# MOOD:  http://8tracks.com/explore/anime
exit ;;
oldie) loadsongs <<EOT
http://cent4.serverhostingcenter.com/tunein.php/ksbepaeb/playlist.pls
http://somafm.com/bootliquor.pls
EOT
exit ;;
esac

loopback() {
    local cfg=~/".shell/../media/mpd/mpd-own.conf"
    if ! pgrep -f "mpd \S+\.${cfg##*.}"; then
        if pgrep mpd >/dev/null; then mpd --kill; fi
        mpd "$cfg"
    fi
    ncmpcpp
}

case "$CURR_PROF" in
  home) loopback; exit ;;
laptop) srv=lsir ;;
     *) srv=sir  ;;
esac

SESSION='sir-mpd'
pane_name()  { tmux send-keys "printf '\\033]2;%s\\033\\\\' '$1'" 'C-m'; }
[ "$1" == '-k' ] && tmux kill-session -t $SESSION


if ! tmux has-session -t $SESSION; then
    tmux new-session -d -s $SESSION -n mpd
    tmux rename-window -t $SESSION:1 'mpd'

    pane_name move
    tmux send-keys "cls && ssh -t $srv 'cd ~/.i3/dmenu; exec \$SHELL -l'" 'C-m'

    tmux split-window -v -p 85

    pane_name ncmpcpp
    tmux send-keys "cls && ssht mpd" 'C-m'

    tmux select-pane -U

    # tmux main-pane-height 8
    # tmux select-layout main-horizontal
fi
tmux attach -t $SESSION

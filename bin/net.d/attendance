#!/bin/bash -e
source ~/.shell/profile

parse(){ sed -r ' /(([0-9]{2}:?){3})/s//\n\1 \n/g' | sed -rn '
    /^\s*(\(?([0-9]{2}:?){2,3}\)?)\s*$/s//\1/gp;
    /^.*>(([0-9]{2}\.?){2}|Sub total|Total)((,)?.*(\w{3}))?<.*$/s//\n\1\4\5/gp
    ' | awk '/^$/{print s; s=""} /./{s=s$0"  "} END{print s}'
}

# IE: -A "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko"
wmail="${WORK_MAIL?No mail}"
wsrv="${WORK_SRV_ATTEND?No server}"
get_page(){ curl -q --ntlm --user "${wmail%%@*}" "${wsrv}"; }

if [[ "$1" == -v ]]; then get_page | vimb -
else get_page | sed -r '/^<div id="masterViewContent">/,/^<\/div>/!d' | w3m -T text/html | cat
fi

# Basic    # -b "$cook" --cookie "$cook"
#   curl -q --ntlm --user "${WORK_MAIL%%@*}" "${WORK_SRV_ATTEND}" 2>/dev/null | sed -r '/^<div id="masterViewContent">/,/^<\/div>/!d' | \w3m -T text/html | cat



# Gpg
#   export GPG_TTY=$(tty)
#   http://www.kixx.name/blogs/web_development/encrypt_files_passwords_to_send_securely_by_email_with_gpg
#   https://www.gnupg.org/documentation/manuals/gnupg/Invoking-GPG_002dAGENT.html
#   >https://wiki.archlinux.org/index.php/GnuPG#Unattended_passphrase

# Cookie:
#   7 TAB-separated fields meaning: domain, tailmatch, path, secure, expires, name, value

# Curl primer:
#   http://www.thegeekstuff.com/2012/04/curl-examples/

# Wget
# WARNING: due to bug need Wget !=1.10.2 && !=1.15 for cookies to work
#   wget --user-agent="Mozilla/5.0" --cookies=on --load-cookies "$cook" --save-cookies "$cook" --keep-session-cookies --user="$usr" --ask-password -qO "$addr"  # dld to stdout
# Using Wget To Download Content Protected By Referer And Cookies
#   wget --cookies=on --keep-session-cookies --save-cookies=cookie.txt http://first_page
#   wget --referer=http://first_page --cookies=on --load-cookies=cookie.txt --keep-session-cookies --save-cookies=cookie.txt http://second_page


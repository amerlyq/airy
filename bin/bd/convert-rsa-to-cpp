#!/bin/bash

KEY=${1:-~/.ssh/id_rsa}

N=rsaKey
L=Len
COLS=16

# Fix exponent format
EXP=$(openssl rsa -text -noout -inform PEM -in "$KEY" \
        | sed -n '/^\(publicExponent:\).*(0x\([0-9a-f]\+\))/ s//\2/p')
if [ "$(( ${#EXP} % 2 ))" == 1 ]; then EXP="0$EXP"; fi
EXP=$(printf "$EXP\n" | sed 's/../:&/g')
EXP="    ${EXP:1}"

# Convert key parts
openssl rsa -text -noout -inform PEM -in "$KEY" \
| sed '/^\(\S\+\):/s//\n\0/; $s/.*/\0\n/' | sed '/^modulus:/,$!d' \
| sed "s/^\(publicExponent:\).*/\1\n$EXP/" | sed -n "
/^$/ be;
$ be
/^\(\S\+\):/{ s//uint8_t \1[] =/; p;n; }
H; b
:e
x; i\
{
    s/\n\|\s//g
    s/\([^:]\{2\}:\?\)\{1,$COLS\}/    \0\n/g
    s/[0-9a-f]\{2\}/0x\0/g
    s/:/,/g
    s/,\(\S\)/, \1/g
    s/$/};\n/g
p
" | sed "
    s/modulus/${N}N/
    s/publicExponent/${N}E/
    s/privateExponent/${N}D/
    s/prime1/${N}P/
    s/prime2/${N}Q/
    s/exponent1/${N}DP/
    s/exponent2/${N}DQ/
    s/coefficient/${N}QP/
" | sed "
1 i\
/* Autogenerated `date +"%d-%m-%Y at %T"` from '~${KEY/$HOME}' */\n\n\
\#include \"rim_rsa_key.h\"\n
/^uint8_t\s\+\(\S\+\)\[\s*\].*/{ h; s//\1/; x }
/^};/ {
    p; x;
    s/.*/uint32_t \0$L = sizeof(\0);/
}
"
# echo "<-----end----->"
# read tmp


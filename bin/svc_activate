#!/bin/bash -eu
source ~/.shell/func.d/system
trap_errors

# TRY: special symlinking
#    systemctl link /root/systemd/forwjour.service

DIR=/etc/systemd/system
A=''  # system-wide
sudo=sudo
OPTIND=1
from=./unit

# copy/enable/re-*/run/user
while getopts 'cef:rRu' o; do case $o
in u) A=--user; sudo=''; DIR=~/.config/systemd/user
      # ALT:CHECK:(faster startup) /etc/systemd/user
;; f) from=$OPTARG
;; :|'?') die 1
esac; cfgOptAdd "$o"; done; shift $((OPTIND - 1))
(($#)) || die 1 "No svc list"
# EXPL: split in stages -- to take dependency into account


# ALSO: for ubuntu >= 16 which has systemd
if has_pr systemd-notify && systemd-notify --booted; then

  if cfgOpt c; then
    do_replace=0
    for f in "$@"; do
      # MAYBE: move local svc searching into func.d/cfgsetup wrapper
      [[ -f $from/$f ]] && f=$from/$f \
      || [[ -f ./$f ]] || die 1 "Not found '$f'"
      if ! diff -q "$PWD/$f" "${DIR:?}/$f" &>/dev/null; then
        do_replace=1
        linkcp ${sudo+-s} -ct "${DIR:?}" "$f"
      fi
    done
    ((!do_replace)) || $sudo systemctl $A daemon-reload
  fi

  cfgNo e || for f in "$@"; do
    if ! systemctl $A is-enabled "$f" &>/dev/null
    then $sudo systemctl $A enable "$f"
    elif cfgOpt f; then $sudo systemctl $A reenable "$f"
    else echo "-> @ $f"
    fi 2>&1
  done
  # elif cfgNo e; then $sudo systemctl $A disable "$f"

  cfgNo rR || for f in "$@"; do
    if ! systemctl $A is-active "$f" &>/dev/null; then
      $sudo systemctl $A start "$f"
    elif cfgOpt R; then
      $sudo systemctl $A restart "$f"
    fi 2>&1
  done

elif distro ubuntu; then

  # Enable
  for f in "$@"; do
    if cfgOpt e
    then $sudo update-rc.d "$f" defaults
    else $sudo update-rc.d -f "$f" remove
    fi 2>&1
  done

  # Run
  cfgNo r || for f in "$@"; do
    $sudo service "$1" restart 2>&1
  done
fi

#!/bin/bash

MAXWAIT=30

# Kill all childs
# ( while kill -0 $$ 2>/dev/null && timeout 5 sdb root on; do
#     sleep "${TIMEOUT:-5}"; done && kill -s SIGKILL $$ >/dev/null 2>/dev/null ) &
# exec sdb shell $@

lau() {
    local pr="$1" args="${@:2}"
    if which "$pr" 2>&1 /dev/null || [ -f "$pr" ]; then
        if ! pgrep "$pr" > /dev/null; then
            "$pr $args" & # Handle arguments with whitspaces

            # Start the given command and wait until it's visible
            # ERROR: this block is infinite for ~/.i3/blocks/kbdd-i3blocks
            #
            # mypid=$! # Pid of last background process
            # for i in `seq $MAXWAIT`; do
            #     echo "Wait: $i"
            #     if xdotool search --onlyvisible --pid $mypid; then
            #         return 0;
            #     fi
            #     sleep 1
            # done
            #
            # printf "Error on executing: $pr $args\n"
            # # notify "Error on executing: $pr $args" &
            # return 1;
        fi
    fi
}

# To be able to restart programms / reload configs for those which already launched!
rcf() {
    kill $(ps opid= -C $1)
    lau $@
}


### ONCE ### ----------------------------------------

lau kbdd
lau ~/.i3/blocks/kbdd-i3blocks
rcf dunst
lau compton
lau mpd
lau copyq


### ALWAYS ### --------------------------------------

setX ktdaw &

[ -f ~/.Xresources ] && xrdb ~/.Xresources &
#[ -f ~/.Xdefaults ] && xrdb -merge ~/.Xdefaults &

# Focus certain wksp
#i3-msg workspace "$(i3-msg -t get_workspaces | sed 's/.*"num":1,"name":"\([^"]*\).*/\1/')" &

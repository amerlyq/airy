#!/bin/bash
source ~/.shell/profile
echo "[auto-start]: '$CURR_PROF' profile"

# BUG: may affect problems for multiple X-sessions

# SEE -- double fork technique
#   http://stackoverflow.com/questions/3430330/best-way-to-make-a-shell-script-daemon#

MAXWAIT=30

# Kill all childs
# ( while kill -0 $$ 2>/dev/null && timeout 5 sdb root on; do
#     sleep "${TIMEOUT:-5}"; done && kill -s SIGKILL $$ >/dev/null 2>/dev/null ) &
# exec sdb shell $@

# # pgrep $1 >/dev/null || $@ &
# lau(){ if hash $1 >/dev/null 2>&1; then $@ & fi; }

lau() {
    local pr="$1" args="${@:2}"
    if hash "$pr" >/dev/null || [[ -f "$pr" ]]
    then if ! pgrep "$pr" >/dev/null; then
            printf "exec:    $pr $args \n"
            $pr $args &

            # Start the given command and wait until it's visible
            # ERROR: this block is infinite for ~/.i3/blocks/kbdd-i3blocks or dunst.

            # mypid=$! # Pid of last background process
            # for i in `seq $MAXWAIT`; do
            #     echo "Wait $pr $mypid: $i"
            #     if xdotool search --onlyvisible --pid $mypid --name "$pr"; then
            #         return 0;
            #     fi
            #     sleep 1
            # done
            #
            # printf "Error on executing: $pr $args\n"
            # notify "Error on executing: $pr $args" &
            # return 1;
        else printf "running: $pr $args \n"
        fi
    else printf "No such: $pr $args \n"
    fi
}

# To be able to restart programms / reload configs for those which already launched!
rcf() {
    local pid=$(ps opid= -C ${1##*/})
    [[ -n "$pid" ]] && kill $pid
    lau $@
}


### ALWAYS ### --------------------------------------
# BUG: No PulseAudio daemon running, or not running as session daemon.
setX a
r.touchpad
r.xkb

# EXPL: don't launch other apps for one-app sessions
[[ "$XDG_CURRENT_DESKTOP" =~ ^(i3|xmonad) ]] || exit

### WM ###
lau r.xcape
lau r.dunst
lau compton  # Must be launched before installing wallpaper!
case "$XDG_CURRENT_DESKTOP"
in xmonad) lau r.tray
esac
lau r.feh
rcf r.mpd-log

### USER ### ----------------------------------------
lau copyq
[[ "$CURR_PROF" =~ ^(home|laptop) ]] || lau pidgin
[[ ! "$CURR_PROF" =~ ^work ]] || lau skype

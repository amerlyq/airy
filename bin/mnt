#!/bin/bash -e
source ~/.shell/profile

# ???? instead of file name
# sudo LC_ALL="ru_RU.UTF-8" ranger (don't work but helps)

# Mount fs by SSH
# https://ru.wikipedia.org/wiki/Mount

# Disk mounting util
if [[ -n "$1" && ${#1} -le 2 ]]; then ACTION="${1}"; shift; else ACTION="m"; fi

LBL="${1}"
MNT="/media/${CURR_USER:-`whoami`}"
DIR="$MNT/$LBL"

if [[ -z "$LBL" ]]; then
    printf "LABELS: " && cd /dev && ls --color=auto disk/by-label
    printf "DISKS: " cd /dev && ls --color=auto sd?[0-9]
    printf "SAMBA: android seclab install ${WORK_MAIL%@*}\n"
    printf "ACTIVE: " && ls --color=auto "$MNT"
    exit
fi

die() { printf "%s\n" "$@"; exit 1; }
check() { grep -qsw "$DIR" /proc/mounts && die "Already mounted at '$DIR'!"; }
clean() { check; if [ -d "$DIR" ]; then
rmdir "$DIR" 2>/dev/null ||
    sudo rmdir -v "$DIR" || die "Can't remove directry '$DIR'!"
fi; }
dirmk() { clean; mkdir -p "$DIR" 2>/dev/null ||
    sudo mkdir -p "$DIR" && sudo chown $CURR_USER:$CURR_USER "$DIR" || die "Error: Can't create directory for mount!"
}


# Need package 'jmtpfs', unmount by fusermount -u "$DIR"
domtp() { dirmk && jmtpfs "$DIR"; }
dosamba() {
    dirmk && sudo mount -t cifs -o user="${1?Need user}" "//${2?Need share}/" "$DIR" \
        && sudo chmod "$CURR_USER:$CURR_USER" "$DIR" && echo "$DIR" || exit
}
doloop() {  # You must launch it from iso's directory!
    DEVPATH="$PWD/$LBL"
    if ! [ -e "$DEVPATH" ]; then die "Error: no such file '$DEVPATH'"; fi
    dirmk && sudo mount -o loop "$DEVPATH" "${DIR%.*}" || exit
}
domnt() {
    local DEVPATH TYPE
    DEVPATH="/dev/disk/by-label/$LBL"
    if [[ ! -L "$DEVPATH" ]]; then DEVPATH="/dev/$LBL"; fi
    if [[ ! -e "$DEVPATH" ]]; then die "No device at path"; fi

    # Flash drive:  http://linuxsam.livejournal.com/18176.html

    # FIXME: it's empty for all disks on my laptop mint?
    declare "$(sudo blkid "$DEVPATH" | awk '{print $NF}')"  # TYPE=...
    if [ "$TYPE" == "vfat" ]; then
        MOPTS="rw,nosuid,nodev,noexec,relatime,uid=1000,gid=1000,fmask=0022,dmask=0077,\
codepage=437,iocharset=iso8859-1,shortname=mixed,showexec,utf8,flush,errors=remount-ro"
    fi
    # -t "$TYPE"
    dirmk && sudo mount "$DEVPATH" "$DIR" ${MOPTS+-o $MOPTS} \
        && sudo chmod "$CURR_USER:$CURR_USER" "$DIR" && echo "$DIR" || exit
}


case "$ACTION" in
 m) domnt ;;
 p) domtp "phone" ;;
 o) doloop "$LBL" ;;
 s) wuser="${WORK_MAIL?No work mail}"; wuser="${wuser%@*}"
    case "$LBL" in
    android) dosamba ${ADR_USER?No var} $ADR_IPL ;;
     seclab) dosamba $wuser ${SURC_SRV?No wsrv}/Exchange ;; #{Books}
     $wuser) dosamba $wuser $SURC_SRV/$wuser ;;  #/{OR /exchange,/projects}
    install) dosamba $wuser s-file.${SURC_SRV#*.}/install ;;
    esac ;;
 u) sudo umount -v "$DIR"; clean || exit ;;
#U) sudo umount -v -R "$MNT"/* && sudo rmdir -v "$MNT"/* ;;  # ERROR: No -R key
 i) sudo blkid ;;  # Get table disk/label/filesystems
 *) echo "Error: '$ACTION'" ;;
esac

#!/bin/bash
#
# SPDX-FileCopyrightText: 2020 Amerlyq <amerlyq@gmail.com> and contributors.
#
# SPDX-License-Identifier: MIT
#
#%SUMMARY: copy current title/url or use selected text as title
#%USAGE: :bind yv spawn --userscript yank_nou
#%OR(with-args): :bind yV set-cmd-text -s :spawn --userscript yank_nou
#%DEBUG: $ QUTE_COUNT=2 QUTE_TITLE=aaa QUTE_URL=bbb ./yank_nou
set -o errexit -o noclobber -o noglob -o nounset -o pipefail

# NOTE: cache last indent count
cache=$TMPDIR/qute.cfg
[[ ${QUTE_COUNT-} ]] || [[ ! -f $cache ]] || QUTE_COUNT=$(sed -n '/^[0-9]$/s//\0/p;q' "$cache")

# HACK: use count=10 to use no indent
count=$(( ${QUTE_COUNT:-1} % 10 ))
echo "$count" >| "$cache"

pfx=${1-}

# HACK: timestamp working as xref
ts=$(printf '%08x' "$(date +%s)" | xxd -r -p | basenc --z85 | rev)

exec xsel -ib <<EOT
$(printf "%$((count * 2))s")${pfx}${QUTE_SELECTED_TEXT:-$QUTE_TITLE} âŒ‡$ts
$(printf "%$(((count + 1) * 2))s")$QUTE_URL
EOT

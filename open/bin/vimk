#!/usr/bin/env bash
set -euo pipefail

nm=${1:-$(mktemp)}

true > "$nm"
chmod 755 "$nm"

cat>> "$nm" <<'EOT'
#!/usr/bin/make -sf
.DEFAULT_GOAL = all
MAKEFLAGS += -rR --print-directory
SHELL := $(shell which bash)
.SHELLFLAGS := -euo pipefail -c
.SUFFIXES:

this := $(lastword $(MAKEFILE_LIST))
d_pj := $(patsubst /,,$(realpath $(dir $(this))))
PHONY := $(shell sed -rn 's/^([A-Za-z0-9-]+):(\s.*|$$)/\1/p' '$(this)'|sort -u|xargs)
help: ; @echo "Targets: $(PHONY)"; sed -rn '/^(.*\s)?#%/s///p' '$(this)'
.PHONY: $(PHONY)
$(this): ;
EOT

[[ -t 0 ]] || cat >> "$nm"
[[ -t 1 ]] && $EDITOR +'$' "$nm"

#!/bin/bash -eu

dst=${TMPDIR:-/tmp}

while getopts 't:p:' o; do case $o in :|'?') exit 1
;; t) dst=$(readlink -m "$OPTARG")
;; p) prf=$OPTARG
esac; done; shift $((OPTIND - 1))

build() { local p d f bin cflags
  p=$(readlink -m "$1")
  d=${p%/*}
  f=${p##*/}
  bin=$dst/${prf-}${f%.*}

  if [[ $p -nt $bin ]]; then
    # https://wiki.gentoo.org/wiki/GCC_optimization/ru
    cflags=( -march=native -O3 -pipe -I "$d" -DSRC_PATH="$p" -o "$bin" "$p" )
    case "$f"
    in *.c  ) gcc -std=c11 "${cflags[@]}"
    ;; *.cpp) g++ -std=c++11 "${cflags[@]}"
    ;; *.hs ) ghc -O -o "$bin" "$p"
    esac
  fi

  echo "(%)  ${bin##*/}"
}

for f in "$@"; do build "$f"; done

#!/bin/bash -e
source ~/.shell/profile

# USE: 'r.chroot 1' -- to load second chroot from list
case "$1" in [0-9]) index=$1; shift ;; esac
prf="${CURR_CHROOTS[${index:-0}]:?No}"
chroot="${CURR_DIR_CHROOT:?No}/$prf"

# EXPL: Derive mounted/overrided PWD for chroot
dir="$PWD"
[[ "${dir#$chroot}" == "$dir" ]] || dir="${dir#$chroot}"
unset ismounted && while read line; do
    [[ "${dir#$line}" == "$dir" ]] || ismounted=1
done < <(awk '/^\//{print$1}' /etc/schroot/default/fstab)
[[ -n "$ismounted" || -d "$chroot$dir" ]] || dir=/cryptfs/workspace

# EXPL Export SHELLRC_EVAL to source env in each spawned shell from ranger
schroot -c "$prf" -d "$dir" -- bash --rcfile <(cat - <<EOT  ${@:+-c "$@"}
export SHELLRC_EVAL='\
    . /cryptfs/_/cfg/env;\
    . /cryptfs/_/cfg/bash_extension.sh;\
    export DISPLAY='$DISPLAY';\
    export EDITOR=vim'
. ~/.profile
EOT
)
# ALT: NOTE failed to setup schroot.conf to export only choosen env variables.
# schroot -c lucid_i386 -d "$dir" -- bash --rcfile <(echo "
#     export SHELLRC_EVAL='. /cryptfs/_/cfg/env; . /cryptfs/_/cfg/bash_extension.sh'
#     export DISPLAY='$DISPLAY'
#     . ~/.bashrc
#     EDITOR=vim
# ") ${@:+-c $@}

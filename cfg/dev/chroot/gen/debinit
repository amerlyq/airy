#!/bin/bash -e
source ~/.shell/profile

ARG=$1  # -u

debcfg(){ local chr=${1:?No chr} nm=${2:?No nm}
  [[ $ARG =~ u ]] || ! grep -qF 'multiverse' /etc/apt/sources.list &>/dev/null || return 0
  local mirror='ftp://ubuntu.ip-connect.vn.ua/mirror/ubuntu'
  local user=${USER:?}

  # BUG: problems with groups transition
  # FIND: export/login with only choosen groups on schroot
  echo "W: security! change root/user passwords in chroot!"
  # THINK:TRY: copy from host only necessary lines?
  sudo schroot -c "${chr##*/}" -d "/" -- bash -c "
    (cd /bin && ln -sfv bash sh)

    tee /etc/apt/sources.list <<<'deb $mirror $nm main universe multiverse'
    apt-get update
    apt-get upgrade

    locale-gen 'en_US.UTF-8'  # NEED: locales
    # sudo dpkg-reconfigure tzdata

    id -g $user &>/dev/null || groupadd $user
    id -u $user &>/dev/null || useradd -m -g $user -G users,uucp -s /bin/bash $user
    gpasswd -a $user uucp  # FIND: useradd is not enough to add to group?
    printf '%s' root:root   | chpasswd
    printf '%s' $user:$user | chpasswd

    # NOTE: only after install/update 'sudo'
    sed -i '/^$user ALL.*/d; \$a\\$user ALL=(ALL) ALL' /etc/sudoers
"; }

dir=${CURR_DIR_CHROOT:?} && [[ -d $dir ]]
for prf in "${CURR_CHROOTS[@]:?}"; do
  linkcp -sc {,"$dir/$prf"}/usr/share/terminfo/s/st-256color
  linkcp -sc {,"$dir/$prf"}/usr/share/terminfo/t/tmux-256color
  debcfg "$dir/$prf" "${prf%_*}"
done

#!/bin/bash -e
cd $(dirname $(readlink -m ${0}))

case "$1" in
-u|--update) update="$1" ;;
esac

# Main destination for Zsh
ZDOTDIR=~/.cache/zsh
PREZTO="$ZDOTDIR/.zprezto"
mkdir -vp "$ZDOTDIR"

run() { hash $1 >/dev/null 2>&1 && /usr/bin/env $@; }
if [[ ! -d "$PREZTO" ]]; then
    run git clone --recursive 'https://github.com/sorin-ionescu/prezto.git' "$PREZTO"
    # run git clone https://github.com/robbyrussell/oh-my-zsh.git $ZSH_DIR
fi

link(){ [[ ! -e $2 || -L $2 ]] && ln -sfvT "$1" $2; }
link "$PWD/zshenv" ~/.zshenv
link "$PWD/prompt" "$PREZTO/modules/prompt/functions/prompt_amer_setup"

for nm in zlogin zprofile zshrc zpreztorc
do link "$PWD/$nm" "$ZDOTDIR/.${nm##*/}"; done


# Choose default shell
if [[ "$(which zsh)" != $SHELL ]]; then
    sudo chsh -s $(which zsh)
    sudo usermod -s $(which zsh) "$(whoami)"
fi


if [[ "$update" -eq 1 ]]; then
    # chsh -s /bin/zsh
    (cd "$PREZTO" && git pull && git submodule update --init --recursive)
fi

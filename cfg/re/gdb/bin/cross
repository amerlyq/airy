#!/bin/sh -eu

refresh=0
case ${1+$1} in -R) refresh=1; shift; esac  # TEMP

# NOTE: necessary only for toolchain (if session found)
[[ -s /etc/debian_chroot ]] && cmd=() || cmd=( r.chroot )
cmd+=( ./gdb -q )
cmd+=( -iex "set auto-load safe-path $PWD" )


# TODO: generate only for toolchain
# BAD:(batch processing) session must be created single time and then reused again and again (don't rm $tmp)
# ALT: all shell cmds must be called from inside single gdb session and resulsts sourced back (rm $tmp on exit)
# DEV: allow overriding symlinks/cfg by specifying ROOT, etc in 'compile' scripts -- when cdir has multiple
tmp=$(r.gdb-tmp)
if [[ ! -d $tmp ]] || ((refresh)); then
  r.gdb-params
  r.gdb-cfg
fi
cd "$tmp"

cmd+=( -x init.cfg )
# TODO: activate only on specific flags ?
# if [[ -t 0 ]]
# then printf '%s\n' "${@:?}" > cmd
# else cat > cmd
# fi

# NEED: when running without chroot
# export SHELL=$(which r.shell)
exec "${cmd[@]}" "$@"
# exec r2 -a mips "$file" "$core"

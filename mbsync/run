#!/bin/bash -eu
#%USAGE: $ ./$0 [<account>] [-- [<mbsync_args>]]
#% * sync all   $ r.mbsync -- all
#% * sync inbox $ r.mbsync -- -qV inbox
#% * pull new   $ r.mbsync -- -qq new
#%
#%DEBUG pull    $ r.mbsync -- -qV --pull-new new
#% -a|--all     # all channels
#% -l|--list    # only list mailboxes
#% -V|--verbose # verbose (show files to remove/resync: <dir>/.uidvalidty)
source ~/.shell/profile

(($#)) && [[ $1 != -- ]] && acc=$1 && shift || acc=${MUTT_DEFAULT:?}
[[ ${1-} == -- ]] && shift

# NOTE: set default channel
(($#)) || set -- "$acc"

cfg=${XDG_CONFIG_HOME:-$HOME/.config}/mbsync/acc/"$acc"
# ALT: mdir=${MAIL:-${MAILDIR:-${MAILROOT:-$HOME/.mail}/$acc}}
mdir=$(sed -rn '/^\s*Path\s+(.*)\s*($|#.*)/s//\1/p' "$acc")
mkdir -p "$mdir"

# INFO: "davmail" sync speed is ~100 / min
#   ~50 dirs is 1 min for idle check; no effect from PipelineDepth
mbsync --config "$cfg" "$@"

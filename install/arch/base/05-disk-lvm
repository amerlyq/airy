#!/bin/bash -e
source ~/sys_funcs
is_enabled 'lvm' || exit 0

## Physical disk and LVM volume group name
sd="${SYS_DISK:?No}"
gr=lvm


## Init disks/partitions
lvmdiskscan
## For SSD:  pvcreate --dataalignment 1m $sd
parted -s -a opt $sd mklabel msdos
pvcreate --zero y -f $sd   # May use list of disks/partitions
pvdisplay
pvs


## Create group
# You can create more than one volume group if you need to, but then you
# will not have all your storage presented as one disk.
vgcreate $gr $sd
vgdisplay
vgs


## If there are no logical volumes under /dev/mapper, run next commands to
## bring up the modules and to make volume group available:
# modprobe dm-mod   # dm-mod needs to be loaded before doing anything with LVM
# vgscan            # Scans all disks for volume groups and re-builds caches
# vgchange -ay      # Makes the logical volumes known to the kernel

for i in ${!SYS_PART[@]:?No}
do
    nm="${SYS_PART[$i]:?No}"
    sz="${SYS_SIZE[$i]:?No}"
    fs="${SYS_FS[$i]:?No}"
    dev="${SYS_PREF?No}${nm}"

    case "$fs"
    in  swap) lvcreate $gr -C y -L $sz -n $nm && mkswap $dev
    ;;     *) [[ "$sz" =~ '%' ]] && lopt='-l' || lopt='-L'
              lvcreate $gr $lopt   $sz -n $nm && mkfs.${fs} $dev  # -L Media
    ;; esac
done
lvs


## Layout
lsblk $sd
echo ":: disk lvm"

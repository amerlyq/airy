# vim: ft=xf86conf
#%USAGE: xorg startup configuration -- copy and edit in private configs

# OFF:
#   https://www.x.org/releases/current/doc/man/man5/xorg.conf.5.xhtml
#   https://download.nvidia.com/XFree86/Linux-x86_64/455.38/README/editxconfig.html
#   https://download.nvidia.com/XFree86/Linux-x86_64/455.38/README/xconfigoptions.html
#   https://download.nvidia.com/XFree86/Linux-x86_64/455.38/README/configtwinview.html
#
# TUT:
#   https://help.ubuntu.com/community/NvidiaResolutionXorgConf
#   https://blogshit.baka.fi/2020/07/xorg-custom-resolutions/
#   https://kodi.wiki/view/Archive:Configuring_resolution_via_xorg.conf
#
# SEE:
#   https://superuser.com/questions/981157/writing-xorg-custom-modeline-for-1366x768-with-nvidia-driver
#   https://unix.stackexchange.com/questions/409857/add-and-use-new-modeline-with-nvidia-driver
#   https://forums.developer.nvidia.com/t/reference-to-xorg-conf-and-resolution-settings/65920
#   https://forums.developer.nvidia.com/t/352-63-regression-noedidmodes-breaks-custom-modeline-modes-ubuntu-14-04/40369
# DEBUG: sudo \X :1 -verbose 6 &>! xlog.txt


Section "Device"
    Identifier      "Nvidia"
    Driver          "nvidia"
    VendorName      "NVIDIA Corporation"
    BoardName       "GeForce RTX 2080 Ti"

    # FAIL: (WW) NVIDIA(0): Option "NoLogo" is not used
    # Option          "NoLogo"                "true"

    # CHECK:BAD: disabling this option makes permanent "Adaptive" instead of "Performance"
    # Option          "ConnectToAcpid"        "0"

    # HACK: faster monitor detection on startup
    #   FAIL: disables all DP-* monitors
    Option          "ConnectedMonitor"      "DFP"

    # HACK: disable Adaptive power mode to prevent high-freq "coil whining" from GPU
    # SRC: https://unix.stackexchange.com/questions/411428/xorg-conf-nvidia-performance-settings-for-ac-battery
    # Option          "RegistryDwords"        "PowerMizerEnable=0x1; PerfLevelSrc=0x2222; PowerMizerDefault=0x1; PowerMizerDefaultAC=0x1"

    # ALSO: NoEdidModes
    Option          "ModeValidation"        "AllowNonEdidModes,ObeyEdidContradictions,NoHorizSyncCheck,NoPredefinedModes,NoVesaModes,NoXServerModes,NoUserModes"
    Option          "IncludeImplicitMetaModes" "off"

    # Option          "Monitor-DP-0"          "<default monitor>"
    # Option          "Monitor-HDMI-0"        "<secondary>"
    Option          "Monitor-DP-0"          "<secondary>"
    Option          "Monitor-HDMI-0"        "<default monitor>"

    ## NOTE: can't hide unnecessary implicit modes, but at least first entry can be used to set DFL mode
    Option          "MetaModes" "HDMI-0: 3840x1600_75;HDMI-0: 2560x1067_75;HDMI-0: 1920x1080_60;HDMI-0: 1920x800_75"

    ## DEBUG
    Option          "ModeDebug"
    # FAIL: (WW) NVIDIA(0): Option "moreVerboseModeValidation" is not used
    # Option          "moreVerboseModeValidation" "true"
EndSection


Section "Modes"
    Identifier      "<ultrawide>"
    ## NOTE: generated by "cvt" BET:USE:DFL: from EDID
    # FMT: mode rrate | hdisp, hsyncstart, hsyncend, htotal | vdisp, vsyncstart, vsyncend, vtotal
    # 3840x1600 74.99 Hz (CVT) hsync: 125.38 kHz; pclk: 664.00 MHz
    # Modeline "3840x1600_75"  664.00  3840 4152 4568 5296  1600 1603 1613 1672 -hsync +vsync
    # 3840x1600 59.96 Hz (CVT) hsync: 99.42 kHz; pclk: 521.75 MHz
    # Modeline "3840x1600_60"  521.75  3840 4128 4544 5248  1600 1603 1613 1658 -hsync +vsync
    # 1920x1080 59.96 Hz (CVT 2.07M9) hsync: 67.16 kHz; pclk: 173.00 MHz
    # Modeline "1920x1080_60"  173.00  1920 2048 2248 2576  1080 1083 1088 1120 -hsync +vsync

    ## NOTE: precise values taken from "Xorg -verbose 6" logs by EDID
    # BAD:(75): hsync=128.694 kHz (>) hrange=<125kHz
    # Modeline "3840x1600_75"  531.25  3840 3888 3920 4128  1600 1607 1617 1716 +HSync -VSync
    # Modeline "3840x1600_60"  422.00  3840 3888 3920 4128  1600 1607 1617 1704 +HSync -VSync
    # Modeline "1920x1080_60"  148.50  1920 2008 2052 2200  1080 1084 1089 1125 +HSync +VSync
    # Modeline "1920x1080_75"  220.64  1920 2056 2264 2608  1080 1081 1084 1128 -HSync +VSync

    ## INFO: precise 2/3 is 2560x1066.6(6) BUT we pick next pixel to reduce vertical muar
    ## BAD: "cvt" has much larger pixel clock than EDID above
    #    LORE: https://github.com/kevinlekiller/cvt_modeline_calculator_12/blob/master/cvt12.c
    #    OFF: http://umc.sourceforge.net/
    #    OFF: http://lrmc.sourceforge.net/
    # 2560x1067 74.91 Hz (CVT) hsync: 83.67 kHz; pclk: 290.50 MHz
    Modeline "2560x1067_75"  290.50  2560 2744 3016 3472  1067 1070 1080 1117 -hsync +vsync
    # 1920x800 74.93 Hz (CVT) hsync: 62.79 kHz; pclk: 160.75 MHz
    Modeline "1920x800_75"   160.75  1920 2040 2240 2560  800 803 813 838 -hsync +vsync
    ## XXX:experimental
    # 3840x1600 59.96 Hz (CVT) hsync: 98.69 kHz; pclk: 394.75 MHz
    # Modeline "3840x1600R"  394.75  3840 3888 3920 4000  1600 1603 1613 1646 +hsync -vsync
EndSection


Section "Monitor"
    Identifier      "<default monitor>"
    # Identifier      "LG ULTRAWIDE"
    ModelName       "LG ULTRAWIDE"
    VendorName      "GSM"

    ## NOTE: measured=874x366 .vs. EDID=870x370 -> DPI=112x109
    # DisplaySize     874  366
    # Option "DPMS" "true"

    # WARN: <default> monitor must always be "primary", otherwise it becomes black (wrong DPI?)
    # Option          "Primary"               "True"
    # Option          "PreferredMode"     "3840x1600_75"

    ## Enable connected monitor on startup (DFL=true)
    # FAIL: (WW) NVIDIA(0): Option "Enable" is not used
    # Option          "Enable"    "True"

    #|read-edid| SRC: $ find /sys -name edid -exec sh -c 'parse-edid < {}' \;
    ## Monitor Manufactured week 10 of 2017
    ## EDID version 1.3
    ## Digital Display
    #DisplaySize 870 370
    #Gamma 2.20
    #Option "DPMS" "true"

    # INFO: Maximum pixel clock is 540MHz (manually parsed EDID) OR: =600MHz (Xorg logs from nvidia driver)
    ## DEPR: use EDID directly
    # HorizSync       30-125
    # VertRefresh     56-75
    UseModes        "<ultrawide>"
EndSection


Section "Screen"
    Identifier     "Screen0"
    #The next line disables some safety checks imposed by the Nvidia driver
    #It uses the display's EDID so that they are only disabled for the XL2420Z and
    #not any other displays.
    #Without this line the custom resolution will be rejected as unsafe.
    # Option         "ModeValidation" "DPY-EDID-edbe03be-f4a0-3a94-b9e8-00884a48f8f4: AllowNonEdidModes,NoMaxPClkCheck,NoEdidMaxPClkCheck,NoHorizSyncCheck"

    # ATT: This is important so that the monitor block above is actually used!
    Monitor        "<default monitor>"

    ## FAIL: does not hide implicit modes added w/o NoEdidModes
    # SubSection     "Display"
    #     Depth       24
    #     Modes      "3840x1600" "1920x1080"
    # EndSubSection
EndSection


# Section "Monitor"
#     Identifier      "<secondary>"           # LG PBP or HTC Vive
#     DisplaySize     874  366
#     Option          "Primary"               "False"
#     Option          "RightOf"               "<default monitor>"
#     # FAIL: if monitor is enabled on the start -- then "xrandr --setmonitor" won't work on it
#     Option          "Enable"                "False"
#     # Option          "Ignore"                "True"
#     VertRefresh     50.0-75.0
#     UseModes        "<ultrawide>"
# EndSection



## BAD: unsupported ?
# xrandr --setmonitor DP-2~2 914/208x1600/366+0+0 DP-2 --setmonitor DP-2~1 2926/666x1600/366+914+0 none
# Section "Device"
#     Option          "Monitor-DP-2"      "<sidesplit>"
#     Option          "Monitor-none"      "<mainsplit>"
# EndSection
# Section "Monitor"
#     Identifier      "<sidesplit>"
#     DisplaySize     208  366
#     Option          "PreferredMode"     "3840x1600"
#     Option          "Position"          "0 0"
# EndSection
# Section "Monitor"
#     Identifier      "<mainsplit>"
#     DisplaySize     666  366
#     Option          "PreferredMode"     "3840x1600"
#     Option          "Position"          "914 0"
# EndSection
